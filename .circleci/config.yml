version: 2.1

alpine_image: &pythonImage
  docker:
    - image: circleci/python:3.7
commands:
  activate_venv:
    description: Activates python virtual environment using source ~/.devops/bin/activate
    steps:
      - run:
          name: source venv
          working_directory: .
          command: |
            source ./.devops/bin/activate
            python3 --version

jobs:
  setup_virtual_environment:
    <<: *pythonImage
    steps:
      - checkout
      - run:
          name: create python virtual environment
          working_directory: .
          command: |
            pwd
            ls -la
            make setup
      - run:
          name: installing python dependencies
          command: make install

      - run:
          name: installing hadolint and minikube
          command: | 
            pwd
            ls -la
            sudo make install-all

      - persist_to_workspace:
          root: .
          paths:
            - .devops

      - persist_to_workspace:
          root: /bin
          paths:
            - hadolint
            - minikube
  test:
    <<: *pythonImage
    steps:
      - checkout
      - attach_workspace:
          at: .
      - activate_venv
      - run:
          name: run unit tests
          working_directory: .
          command: |
            source ./.devops/bin/activate
            make test
  lint:
    <<: *pythonImage
    steps:
      - checkout
      - attach_workspace:
          at: /bin
      - attach_workspace:
          at: .
      - activate_venv
      - run:
          name: lint project
          working_directory: .
          command: |
            source ./.devops/bin/activate
            make lint
  
  start:
    <<: *pythonImage
    steps:
      - checkout
      - attach_workspace:
          at: /bin
      - attach_workspace:
          at: .
      - activate_venv
      - run:
          name: start app
          working_directory: .
          command: make run

workflows:
  udapepole:
    jobs:
      - setup_virtual_environment
      - test:
          requires: [setup_virtual_environment]
      - lint:
          requires: [test]
      - start:
          requires: [lint]